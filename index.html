<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>タイマー</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: black !important;
      background-image: none !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100vh;
      padding: 20px;
      box-sizing: border-box;
      background: black !important;
      background-image: none !important;
    }
    
    h1 {
      font-size: 32px;
      margin-bottom: 40px;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    #display {
      font-size: clamp(80px, min(30vw, 25vh), 250px);
      font-weight: bold;
      font-family: 'Courier New', monospace;
      color: #fff;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
      margin: 20px 0;
      line-height: 1;
      letter-spacing: 2px;
    }
    
    .controls {
      display: flex;
      gap: 15px;
      margin: 30px 0;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }
    
    button {
      padding: 15px 30px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
      color: #667eea;
    }
    
    button:hover:not(:disabled) {
      background: #f0f0f0;
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    button:active:not(:disabled) {
      transform: scale(0.98);
    }
    
    button:disabled {
      background: rgba(255, 255, 255, 0.5);
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .adjust-btn {
      font-size: 28px;
      padding: 12px 20px;
      min-width: 60px;
    }
    
    .time-label {
      font-size: 24px;
      font-weight: bold;
      color: white;
      min-width: 100px;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .hint {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 40px;
      text-align: center;
      line-height: 1.6;
    }
  </style>
  </head>
<body>
  <div class="container">
    <div id="display" class="display">00:00</div>
    <div class="controls">
      <button id="decrement" class="adjust-btn">−</button>
      <span id="timeLabel" class="time-label">0分</span>
      <button id="increment" class="adjust-btn">+</button>
    </div>
    <div class="controls">
      <button id="startStop">Start</button>
      <button id="reset" disabled>Stop/Reset</button>
    </div>
	<div>
		<input class="preCount" type="checkbox" name="preCount" id="preCount" checked> 事前カウント
	</div>
  </div>
  <script>
  (function(){
    const display = document.getElementById('display');
    const timeLabel = document.getElementById('timeLabel');
    const startStopBtn = document.getElementById('startStop');
    const resetBtn = document.getElementById('reset');
    const incrementBtn = document.getElementById('increment');
    const decrementBtn = document.getElementById('decrement');
	const preCountCheckbox = document.getElementById('preCount');

    if (!display || !timeLabel || !startStopBtn) return;

    let totalSeconds = 0;
    let remainingSeconds = 0;
    let isRunning = false;
    let timerInterval = null;
    let audioCtx = null;
    let countdownStarted = false;
    let timerStartTime = 0;  // timestamp when timer actually started
    let isCountUpMode = false;  // true when initial value is 0 (count-up mode)

    function ensureAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().catch(() => {});
      }
    }

    function beep(freq, durationMs, volume = 0.12) {
      if (!audioCtx) return;
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, now);
      gain.gain.setValueAtTime(volume, now);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + durationMs / 1000);
    }

    function updateDisplay() {
      const mins = Math.floor(remainingSeconds / 60);
      const secs = remainingSeconds % 60;
      display.textContent = String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
    }

    function updateTimeLabel() {
      const minutes = Math.floor(totalSeconds / 60);
      timeLabel.textContent = minutes + '分';
    }

    function setTime(minutes) {
      if (isRunning) return;
      totalSeconds = minutes * 60;
      remainingSeconds = totalSeconds;
      isCountUpMode = (totalSeconds === 0);  // Set count-up mode if 0
      updateDisplay();
      updateTimeLabel();
    }

    function startCountdown() {
      if (totalSeconds === 0 && !isCountUpMode) return;
      if (isRunning) return;

      if (!countdownStarted) {
        // First click: do 3-2-1 countdown with sounds
        countdownStarted = true;
        ensureAudio();
        incrementBtn.disabled = true;
        decrementBtn.disabled = true;

        let n = 3;
        display.textContent = String(n);

		if (preCountCheckbox.checked) {
			(function tick(count) {
			if (count > 0) {
				display.textContent = String(count);
				try { beep(1000, 120); } catch (e) {}
				setTimeout(() => tick(count - 1), 1000);
			} else {
				try { beep(1800, 520, 0.14); } catch (e) {}
				setTimeout(() => {
				remainingSeconds = totalSeconds;
				updateDisplay();
				startTimerNow();
				}, 250);
			}
			})(3);
		}
		else {
			remainingSeconds = totalSeconds;
			updateDisplay();
			startTimerNow();
		}
      }
    }

    function startTimerNow() {
      isRunning = true;
      startStopBtn.textContent = 'Running...';
      startStopBtn.disabled = true;
      resetBtn.disabled = false;
      incrementBtn.disabled = true;
      decrementBtn.disabled = true;
      timerStartTime = Date.now();

      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
        
        if (isCountUpMode) {
          // Count-up mode: increment from 0
          remainingSeconds = elapsed;
        } else {
          // Count-down mode: decrement to 0
          remainingSeconds = Math.max(0, totalSeconds - elapsed);
        }
        
        updateDisplay();
        
        if (!isCountUpMode && remainingSeconds <= 0 && !isCountUpMode) {
          // Countdown finished, switch to count-up mode
          isCountUpMode = true;
          timerStartTime = Date.now();  // Reset timer start time for count-up
          remainingSeconds = 0;
          updateDisplay();
          // Play finish sound - longer and louder
          try {
            beep(800, 300, 0.2);
            setTimeout(() => beep(800, 300, 0.2), 350);
            setTimeout(() => beep(800, 600, 0.25), 700);
          } catch (e) {}
        }
      }, 1000);
    }

    startStopBtn.addEventListener('click', function(e) {
      if (!countdownStarted && (remainingSeconds > 0 || isCountUpMode)) {
        startCountdown();
      }
    });

    resetBtn.addEventListener('click', function() {
      if (isRunning) {
        // タイマー実行中：停止
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        isRunning = false;
        startStopBtn.textContent = 'Start';
        startStopBtn.disabled = false;
        // ボタンは押したままにしてリセット可能
      } else if (countdownStarted) {
        // タイマー停止中：リセット
        countdownStarted = false;
        remainingSeconds = totalSeconds;
        updateDisplay();
        updateTimeLabel();
        resetBtn.disabled = true;
        incrementBtn.disabled = false;
        decrementBtn.disabled = false;
      }
    });

    incrementBtn.addEventListener('click', function() {
      if (!isRunning) {
        const minutes = Math.floor(totalSeconds / 60);
        setTime(minutes + 1);
      }
    });

    decrementBtn.addEventListener('click', function() {
      if (!isRunning) {
        const minutes = Math.floor(totalSeconds / 60);
        if (minutes > 0) {
          setTime(minutes - 1);
        }
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.code === 'Space') {
        e.preventDefault();
        if (!countdownStarted && (totalSeconds > 0 || isCountUpMode)) {
          startCountdown();
        }
      } else if (e.code === 'KeyR') {
        e.preventDefault();
        resetBtn.click();
      }
    });

    // Initialize
    setTime(1);
  })();
  </script>
</body>
</html>

